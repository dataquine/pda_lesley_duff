---
title: "NYC Citi Bike trips"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
#    code_folding: show
date: "`r format(Sys.Date())`"
author: "Lesley Duff"
editor_options: 
  chunk_output_type: inline
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center")
```
# Introduction

[*Citi Bike*](https://ride.citibikenyc.com/about) is the largest [bike share system](https://en.wikipedia.org/wiki/Bicycle-sharing_system) in the USA and 
consists of a fleet of bikes available to users at docking stations throughout 
New York City. Bikes can be returned to any other station. Citi Bike is 
available for use 24 hours/day, 7 days/week, 365 days/year.

Citi Bike would like to know more about the following:

* What is the pattern of bike hires over time (e.g. within a year, month, week, or day)?
* Do bike hire patterns differ between bike rider demographics? (e.g. gender, type of trip, age)
* Any other insights?

The data provided to us is a small sample about bike hires. This is what we are using to do some analysis.

```{r include=FALSE}
library(ggthemes) # Contains colourblind palette
library(scales)
library(tsibble) # time series tibble for the tidyverse
library(tidyverse)
# library(tsibbledata) # contains nyc_bikes dataset
```

```{r}
# Get helper functions ----
source("R/nyc_bikes_helpers.R")
```


```{r include=FALSE}
# Load data set ----
# Use cleaned version
nyc_bikes_clean <- read_csv("clean_data/nyc_bikes_clean.csv")
```
## Ethics

### Human Rights
#### Privacy
Bike hire data relates to the actions of people using the bikes which are hired 
when a user starts a journey using one from a docking station.

The data relating to people includes information about the gender of the person 
and the year of their birth. Also whether they have purchased either a 24-hour 
or 3-day pass, or a "Subscriber" who has purchased an annual subscription.

The start location indicating which station the user started the journey and 
where they were and which station at the end. 

There may be some potential concerns that the location data could be used to 
track where a particular person is but the data is anonymised so that there is 
nothing more specific that could be used to identify a particular individual. 

## General

```{r}
trip_count <- get_trip_count(nyc_bikes_clean)
bike_count <- get_bike_count(nyc_bikes_clean)
start_station_count <- get_start_station_count(nyc_bikes_clean)
end_station_count <- get_end_station_count(nyc_bikes_clean)
```

|Count  | Name |  Description  |
| --------------: | ----- | ------------------ |
| `r trip_count` | trips | bike hires made |
| `r bike_count` | bikes in Citi Bike fleet | bikes used for trips |
| `r start_station_count` | docking stations | used to start trips |
| `r end_station_count` | docking stations | used to end trips |

# Pattern of bike hires

Here we take a look at usage over time.

```{r}
# start_times_df <- nyc_bikes_df %>%
#  select(start_time) %>%
#  index_by(start_time) # %>%
##  summarise(mean_temp = mean(Temperature))
## summarise(hire_start_time_count = n())
```
## Bike Hire by Month

This graph shows how many bike hires there were for each month of 2018.

```{r}
# Convert to tsibble ?as_tsibble
nyc_bikes_clean <- as_tsibble(nyc_bikes_clean, index = start_time)

# View(month_hires_count)
month_hires_count <- get_month_hires_count(nyc_bikes_clean)

month_nyc_bikes_plot <- month_hires_count %>%
  ggplot(aes(x = month_name, y = hires_month_count)) +
  geom_point() +
  geom_line(group = 1) +
  # geom_text(aes(label = hires_month_count))+
  scale_y_continuous(limits = c(0, 800)) +
  theme_minimal() +
  #  theme_tufte() +

  labs(
    x = "\nMonth",
    y = "Number of hires\n",
    title = "Bike Hire by Month",
    subtitle = "Sample data from 2018"
  )

month_nyc_bikes_plot
```

* The highest levels of usage are in the summer months, peaking in August with a total of **`r max(month_hires_count$hires_month_count)`** hires.
* The lowest levels of usage are in the winter months, lowest in February with a total of **`r min(month_hires_count$hires_month_count)`** hires.

```{r}
# get_month_hires_count = function(df)
#  hires_per_bike <- df %>%
#  # ?count
#  # bike_count =
#    count(bike_id, name = "hire_count", sort = TRUE)

# bike_hires <- get_bike_hires(nyc_bikes_clean)
# bike_hires
```

## Bike Hire by Day of Month

Here were are comparing how the pattern of usage changes during each month.

```{r}
hires_day_of_month <- nyc_bikes_clean %>%
  select(start_time, month) %>%
  mutate(month_label = lubridate::month(month, label = TRUE, abbr = TRUE))

hires_day_of_month %>%
  ggplot(aes(x = day(start_time))) +
  geom_histogram(
    color = "white",
    binwidth = 1
  ) + # ?facet_wrap
  facet_wrap(~month_label,
    ncol = 3
  ) +
  theme_tufte() +
  labs(
    x = "\nDay of Month",
    y = "Number of Hires\n",
    title = "Bike Hire by Day of Month",
    subtitle = "Sample data from 2018"
  )
```

* There's a gap showing next to no usage in the middle of January. This should 
be investigated to see if there are external reasons such as poor weather affecting results.

## Bike Hire by Day of Weeks

Here were are comparing how the pattern of usage changes during each month.
