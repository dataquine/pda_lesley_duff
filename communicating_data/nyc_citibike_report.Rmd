---
title: "Citi Bike"
output:
  html_document:
    toc: true
    toc_float: true
date: "`r format(Sys.Date())`"
author: "Lesley Duff"
pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE,
                      echo = FALSE# 
                     # eval = FALSE, fig.align = "center", 
              )
```

```{r}
library(e1071) # tests for skewness
library(ggthemes) # Contains colourblind palette
library(leaflet)  # Maps
library(tidyverse)
library(tsibble) # Time-based functions
```


```{r}
# Load clean dataset
#nyc_bikes <- read_csv("clean_data/nyc_bikes.csv",
#  locale = locale(tz = "America/New_York"))

# nyc_bikes <- as_tsibble(nyc_bikes,
#                        index = start_time,
#                        key = "bike_id")
#str(nyc_bikes)
source("data_cleaning_scripts/nyc_citibike.R")
# Not happy with this but simply have too many problems reading
# a tsibble back in again things break right left and centre

nyc_bikes <- nyc_bikes_clean
```

# 1. Documentation

## Introduction
<!-- Domain knowledge (1.1) -->

[*Citi Bike*](https://ride.citibikenyc.com/about) is the largest [bike share system](https://en.wikipedia.org/wiki/Bicycle-sharing_system) in the United 
States of America and consists of a fleet of bikes available for hire to users 
at docking stations throughout New York City. Hired bikes can be returned to 
any station. Citi Bike is available for use 24 hours/day, 7 days/week, 
365 days/year.

The data provided to us is a small sample of NYC Citi Bike usage of 10 bikes 
throughout 2018.

**Data Source:**

* [NYC Citi Bike trips](https://rdrr.io/github/tidyverts/tsibbledata/man/nyc_bikes.html) dataset from tsibbledata used in this analysis
* [Citi Bike NYC](https://www.citibikenyc.com/system-data) Original Source

## Ethics
### Consent

User data obtained from users creating account accepting terms and conditions. 
Trip data recorded automatically via electronics on bikes and docking stations. 
CitiBike provides a small sample dataset of usage of 10 bikes throughout 2018.

### Human Rights: Privacy

There is information about people and places. Only anonymised data stored in the sample public dataset. Nothing to uniquely identify the demographics or behaviour of a particular person.

**User data:** year of birth is stored and not birth date, gender is optional.  
**Location:** latitude and longitude of the start and end of the journey. This 
is the locations of the docking bike station only, not the location of a person. 
No live tracking of bikes during trip.

## Business requirements
<!-- (1.2) -->

Citi Bike would like to know more about the following:

* The pattern of bike hires over time
* Do bike hire patterns differ between bike rider demographics? (e.g. gender, 
type of trip, age)
* What is the geographical spread of the start points of bike hires?
* Any other insights?

## Business processes and data flow (1.3)

Create a diagram that shows how the Citi Bike dataset is created (which variables are added when) and demonstrates an understanding of the business process and flow of the data.

For example: 

![This diagram was created using draw.io at https://app.diagrams.net](dataflow_example.png)

## Data visualisation as a tool for decision-making
<!-- (1.4)

Briefly describe how this report can help NYC Citi Bikes make better data-driven business decisions.
-->
By looking at a sample across a full calendar year it may give understanding of 
customer behaviour affecting hires to be aware of and to resource availability 
accordingly. Time based data could be incorporated into the scheduling of any 
promotional campaigns. 

Demographics insights could identify potential groups to 
be targeted by marketing activity or drive further separate research into which 
groups drive more hires versus reasons why other don't/can't use it.

## Data types (1.5)

List the different types of variables contained in the dataset and explain each 
of them to a non-technical audience. (e.g. integer, character, datetime)


Inside the original dataset we have the following information available

### Factors
* `bike_id`: Which bike used during the hire

* `start_station`,`end_station`: Which particular starting station
the bike began it's trip and which destination station it ended up at the end of the journey.
* `type`: 
User type.  
**'Customer'** purchased a short-term 24-hour or 3-day pass  
**'Subscriber'** is a long-term Annual Member

### Date and time (S3: POSIXct)
`start_time`,`stop_time`: What date and time the bike trip started/ended a trip 
as part of a hire.

### Location (double)
We have the latitude and longitude as numbers telling us the exactly where the 
bike stations used during a hire are located.
`start_lat`,`end_lat`: Latitude of starting/ending station
`start_long`,`end_long`: Longitude of starting/ending station

### User-supplied information
* `birth_year`: (double) The bike riderâ€™s year of birth.
* `gender`: (factor) User can optionally declare their gender (Male/Female/Unknown)

## Data quality and data bias (1.6)

Do you have any concerns about bias or quality in the dataset? Why/why not?

### Quality
The data supplied as part of the sample appears to be of high quality, no 
missing records were detected. There appears to be some parts directly supplied 
by the user such as Gender/Year of birth. The preliminary analysis revealed over
that for over 6% of trips the gender of the user was unknown. A couple of 
entries gave year of birth of the person hiring the bike as being in the 1880s. 


### Bias
The dataset has been provided by the CitiBike company obtained from 
their systems. The data we have is a sample of a larger dataset. We have no way 
of independently verifying whether the information gathered by CitiBike about 
hires is accurate e.g. are the date/time stamps correct?

We have been provided with no initial information about about how this smaller 
sample was generated e.g. whether truly random over the full data or whether the
sample is from a specific subcategory of e.g. stations/bikes/users.

Possible undercoverage bias? The sample is only for 4268 trips over the course 
of 2018 for just 10 different bikes and only around 50 stations. We can only make observations for that particular year without examining whether there are 
year-to-year trends.

The only information we have is for where bikes have actually been hired, there 
is no data examining reasons for non-hiring, this might be a separate area for 
research work?

Response bias: As indicated in the data quality there are some questionable 
entries in birth year information comes from the user so might have been an 
error on their part mistyping or choosing the wrong year, developers/designers 
should check whether the user interface provided to customers is affecting 
accuracy of data or whether users are deliberately choosing to give a false year. However these are few in number.

### Ethics
#### Consent

User data obtained from users creating account accepting terms and conditions. 
Trip data recorded automatically via electronics on bikes and docking stations. 
CitiBike provides a small sample public dataset of usage of 10 bikes throughout 
2018.

### Human Rights: Privacy

Information about people and places. Anonymised data stored in the sample 
dataset. There is no public data to uniquely identify the demographics or track 
the behaviour of a particular person.

User data: year of birth is stored and not birth date, gender is optional.

Location: latitude and longitude of the start and end of the journey. This is 
the locations of the docking bike station only, not the location of a person. 
No live tracking of bikes during trip.

# 2. Data cleaning

## Preparing data for visualisation (1.7)


The data will be examined to understand how a Citi Bike hire is recorded. 
We will then break down trips against different periods of time to try and 
identify whether there are broad patterns at different times of year or very 
specific ones throughout the day.

For demographics we will look at information relating to the person making the 
hire and whether any particular categories dominate more than others.


Please include your cleaning/wrangling steps under this section.

`0_preliminary_analysis.Rmd` was used for examining the initial quality of the 
data

Cleaning:

* decided to exclude the small number of records with a birth_year > 100 years 
from the year of the sample.

For convenience and visualisation purposes we created the following new 
variables

`rider_age`, (integer), The customer expicity requested age to be examined so 
we calculate age to the nearest year during a hire. 

# 3. Data visualisation

## Process and design (2.1, 2.7, 2.8, 2.9)

Briefly describe your data visualisation process.

First after cleaning the data and adding new variables to assist plotting by different time periods as requested. I started with distribution of hires over a long time (year) and narrowed the time period down to plots of individual days. Initially exploratory histograms to get a general sense of where the time-based entries are distributed.

All visualisations were made in RStudio using the `ggplot` package.*

For example: *First, I investigated variables of interest with simple single-variable distribution plots. Then I plotted variables of interest to the business against each other to see if any patterns were present in the data. After selecting key visualisations I ensured these were clearly portraying the message I wanted to convey, were aesthetically pleasing, as well as accurate and not misleading. All visualisations were made in RStudio using the `ggplot` package.*

## Visualisations (2.2, 2.3, 2.4, 2.5, 2.6)

```{r}
# Visualisation variables for consistent plots
plot_bar_colour <- "white"
plot_fill_colour <- "steelblue"
plot_theme <- theme_minimal()
```

For each plot you include in your report, please:

**Describe the visualisation: what kind of visualisation is it and what information does it contain?**

For example: _This scatter plot shows the relationship between age (years) and spending (GBP), where the red line represents a line of best fit, and the shaded area represents the 95% confidence interval._

**Why is this visualisation important to the business? What does it mean/how can it be used?**

For example: _The highlighted relationship between age and spending can be used by the business to create better targeted advertisements for different age groups as well as make better predictions of customer behaviour._

### Hires over time

#### Year by day of year
```{r}
# Aggregate by date
nyc_bikes_by_date <- nyc_bikes %>%
  index_by(start_date) %>%
  summarise(hires = n()) 

nyc_bikes_by_date %>%
 # index_by(start_date) %>%
  #summarise(hires = n()) %>%
  ggplot(aes(x = start_date, y = hires)) +
  geom_line() +
  plot_theme +
  labs(
    title = "Hires by Day of Year",
    subtitle = "Sample data from 2018",
    x = "\nDate",
    y = "Number of Hires\n"
  )
#nyc_bikes_by_date
```
This line plot shows the relationship between Date by each day of 2018 and the 
Number of Hires.
In general terms we see hires at their lowest in winter months, higher in summer 
with a peak in August.

Just to check which dates are top 5 peaks of hires
```{r}
nyc_bikes_by_date %>%
  arrange(desc(hires)) %>%
  head(5)
```
Three of the top 5 peaks are in August.

#### Year by month
```{r}
# Aggregate by month of year
nyc_bikes_by_month <- nyc_bikes %>%
  index_by(start_month_name) %>% 
  summarise(hires = n())

nyc_bikes_by_month %>%
  ggplot(aes(x = start_month_name, y = hires)) +
  geom_point() +
  geom_line(group = 1) +
  plot_theme +
  labs(
    title = "Hires by Month of Year",
    subtitle = "Sample data from 2018",
    x = "\nMonth",
    y = "Number of Hires\n"
  )
```

This line plot shows the relationship between each month of 2018 and the 
number of hires.

This confirms a steadily rising number of hires per month between February and 
August. Usage then drops sharply in September and carries on dropping til the 
end of the year.

The drop is interestingly not as steep from September to October. CitiBike 
should check whether there's a similar effect in later years. Is there a new 
source of customers specifically in October perhaps related to marketing 
activity or an influx of e.g. students in New York?



#### Days of the Week
```{r}
# Aggregate by day of week
weekend_days <- c("Sun", "Sat")
day_type_labels <-  c("Weekday", "Weekend")
nyc_bikes_by_day_of_week <- nyc_bikes %>%
  index_by(start_day_of_week) %>% 
  summarise(hires = n())

nyc_bikes_by_day_of_week %>%
  ggplot(aes(x = start_day_of_week, y = hires, fill = start_day_of_week %in% weekend_days)) +
  geom_col() +
  geom_text(aes(label = hires), vjust = 1.5, colour = "white") +
  scale_fill_colorblind("Type of Day",
    labels = day_type_labels
  ) +
  plot_theme +
  labs(
    title = "Hires by Days of the Week",
    subtitle = "Sample data from 2018",
    x = "\nDay of Week",
    y = "Number of Hires\n",
    fill = "Weekend"
  )
```

This line plot shows the relationship between the Day of the Week and the 
Number of Hires across 2018.

We see that hires are lower at weekends than weekdays. Resources are less 
heavily used on weekends so there may be scope for promoting more leisure trips 
within the current service capacity.

#### Hours of Day
```{r}
# Aggregate by hour of day
office_hours <- c(8:18) # 9-5 and 1 hr commute

nyc_bikes_by_hour_of_day <- nyc_bikes %>%
  index_by(start_hour_of_day) %>% 
  summarise(hires = n())
nyc_bikes_by_hour_of_day

 nyc_bikes_by_hour_of_day %>%
  mutate(is_office_hours = if_else(start_hour_of_day %in% office_hours,
                                   "Yes", "No")) %>%

  ggplot(aes(x = start_hour_of_day, y = hires, fill=is_office_hours)) +
  geom_col()+
  scale_fill_colorblind("Office Hours")+
  plot_theme+
    scale_x_continuous(breaks = 1:24) + 

  labs(title = "Hires by Hour of the Day",
       subtitle = "Sample data from 2018",
       x = "\nHour of Day",
       y = "Number of Hires\n",
       fill = "Office Hours")
```

### Demographics: User Type (Subscriber vs Customer)

```{r}
nyc_user_type <- tibble(nyc_bikes) %>%
  select(type, start_month_name) %>% 
  group_by(type, month = start_month_name) %>% 
  summarise(hires = n())

nyc_user_type %>% 
  ggplot(aes(x = month, y = hires, fill = type)) +
  geom_col() +
  plot_theme +
  scale_fill_colorblind()+
  labs(
    title = "Hires by User Type",
    subtitle = "Sample data from 2018",
    x = "\nMonth",
    y = "Number of Hires\n",
    fill = "User Type"
  )
```

This bar plot examines the proportions of users who are customers 
vs. subscribers each month of 2018.

We can see that the subscribers drop greatly between August/September and again between October/November.

Subscribers are those who took paid for a year of use. It suggests that many of those who took out subscriptions in August or October the previous year 2017 did not choose to renew. CitiBike should look for explanations - were there any special promotions those months in the previous year? Is there a cyclical drop showing the same pattern in later years?

The proportion of customers seems highest in the summer months. Are people more likely to experiment with the CitiBike service in good weather?

### Demographics: Age and Gender

```{r}
nyc_user_age <- tibble(nyc_bikes) %>%
  select(rider_age, birth_year, gender)

nyc_user_age %>% 
  ggplot(aes(x = rider_age, fill = gender)) +
  geom_histogram(colour = plot_bar_colour, 
                 binwidth = 1) +
  plot_theme+
  scale_fill_colorblind()+
  labs(
    title = "Hires by Age and Gender",
    subtitle = "Sample data from 2018",
    x = "\nAge of Rider",
    y = "Number of Hires\n",
    fill = "Gender"
  )
```
This bar plot shows the numbers of users broken down by the age of the person 
making the hire and their gender during 2018.

We can see that males make a far higher proportion of users than females.
According to [US Censux New York City](https://data.census.gov/table?q=population+by+sex+&t=Age+and+Sex&g=160XX00US3651000&tid=ACSSE2021.K200101) females currently outnumber males.

There does seem to be a positive skew towards younger riders under 40 using the 
service more than older age groups, with peaks for users in their 30s. We will 
now test this.

#### Testing skew by age
```{r}
nyc_user_age_skewed <- nyc_user_age %>%
  select(rider_age) %>% 

  summarise(skewness = skewness(rider_age, type = 1)) 

nyc_user_age_skewed
```

The age distribution is moderately right-skewed with greater hires by younger 
people.

#### Examining hires by gender

```{r}
nyc_user_age %>% 
  select(gender) %>% 
  group_by(gender) %>% 
  summarise(hires = n()) %>% 
  ungroup() %>% 
  arrange(desc(hires))
```

Percentage of those providing a gender female = 930/3069 * 100 = 30.3%
This suggests there could be at least 2,000 females in this sample not using 
the service.

More research should be done into why females are less likely to use the
CitiBike service. Do we know whether females are deliberately choosing not to 
use the services or are there factors like whether they've learned to ride a 
bike when younger?

CitiBike should consider demographically targeted marketing campaigns to 
women e.g. online adverts.

#### Checking the high number of unknowns on only one age group

We will try to investigate why there is such a high proportion of unknown gender 
for just one age.

```{r}
nyc_user_age_unknown <- nyc_user_age %>% 
  filter (gender == "Unknown") %>% 
  group_by(rider_age, birth_year, gender) %>% 
  summarise(hires = n()) %>% 
  ungroup() %>% 
  arrange(desc(hires)) %>% 
  top_n(3)

nyc_user_age_unknown
```
We see that those who claimed to be 49 (born in 1969) account for an 
extraordinarily high proportion of people not supplying a gender.
This maybe suggests these particular users do not want to give accurate 
information about themselves and seem to be selecting a dummy value for age.

Developers could test if they also offered to make providing an age optional 
the same way as gender whether the number claiming a birth_year of 1969 would 
drop and improve the accuracy of the age data.

### Hires by geographical spread

```{r}
nyc_bikes_station_locations <- tibble(nyc_bikes) %>%
  select(start_station, start_lat, start_long) %>%
  group_by(start_station,start_lat, start_long) %>%
  #select(start_lat, start_long) %>%
 # group_by(start_lat, start_long) %>%
  summarise(number_of_hires = n()) %>%
  ungroup()
#nyc_bikes_station_locations

nyc_bikes_station_start_map <- leaflet(nyc_bikes_station_locations) %>%
  addTiles() %>% # use the default base map which is OpenStreetMap tiles
  #?addMarkers

  addCircleMarkers(
    lng = ~ start_long,
    lat = ~ start_lat,
    radius = ~ number_of_hires/20,
    #popup = ~paste("<strong>Number of Hires:</strong>", number_of_hires),
        popup = ~paste("<strong>Number of Hires:</strong>", number_of_hires,
      "<br /><strong>Station Number:</strong>", 
                   start_station),
    label = ~paste("Number of Hires:",number_of_hires)
  ) 

nyc_bikes_station_start_map
```

## Other insights
### Duration
```{r}
#View(nyc_bikes)
nyc_bikes_duration <- nyc_bikes %>%
  select(hire_duration,type, gender, rider_age) %>% 
  mutate(hire_duration_minutes =  
           round(as.numeric(hire_duration, "minutes")),
    duration_category =    
      case_when(
 hire_duration_minutes < 10 ~ "< 10 minutes",
   between(hire_duration_minutes, 10, 19)  ~ "10 -19 minutes",
   between(hire_duration_minutes, 20, 29)  ~ "20 -29 minutes",
   #between(hire_duration_minutes, 30, 3600)  ~ "30 minutes - 6 hours",
  hire_duration_minutes >= 30 ~ "> 30 minutes",
 # hire_duration_minutes >= 10 <= 5 ~ "Medium 10 -19 minutes",
  TRUE   ~ "Unknown"
),
  .after = hire_duration)

nyc_bikes_duration %>% 
  ggplot(aes(x = fct_infreq(duration_category))) +
  geom_histogram(stat="count")+
  plot_theme+
  scale_fill_colorblind()+
  labs(
    title = "Hires by Duration Category",
    subtitle = "Sample data from 2018",
    x = "\nDuration Category",
    y = "Number of Hires\n"
  )    
```

This plot shows number of hires broken down by duration. Duration is the time 
taken between a bike being undocked at a starting station and docked at a
destination station.

[CitiBike pricing](https://citibikenyc.com/pricing) already offers financial 
incentives to keep trips < 30 minutes by charging extra per 15 mins over. 
Majority of trips are well within this with the highest usage being very short 
trips lasting less than 10 minutes. Suggests users find CitiBike worthwhile even 
for relatively short journeys outweighing any time spent walking to find a bike.


## Conclusion

* There are different patterns of usage across a calendar year. Much less usage 
in winter. Suggest further research to see if people feel too unsafe to use 
the service in poor weather. Capitalise on "fair weather" users by offering 
cheaper and easier options for "day trips".
* Overwhelming majority of users are subscribers with yearly membership 
suggesting satisfaction with the service CitiBike offers. Use this confidence 
to tempt potential new users with better financial incentives to try a short 
pass first - discounts on full membership for new customers trying a short pass.
* Males use CitiBike far more than females. Quick win could be to attempt to 
grow female usage through trying targeted marketing campaigns and working with 
female groups in New York City.
